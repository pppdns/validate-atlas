name: 'Validate Atlas Markdown'
description: 'Validates Atlas Markdown files with comprehensive checks for structure, formatting, and compliance'
author: 'pppdns'

inputs:
  file_path:
    description: 'Path to the Atlas Markdown file to validate'
    required: true

outputs:
  has_errors:
    description: 'Whether validation found errors (true/false)'
    value: ${{ steps.validate.outputs.has_errors }}

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
    
    - name: Install dependencies
      shell: bash
      run: |
        cd ${{ github.action_path }}
        npm ci --prefer-offline --no-audit
    
    - name: Run validation
      id: validate
      shell: bash
      run: |
        # Store the relative file path for annotations
        RELATIVE_FILE_PATH="${{ inputs.file_path }}"
        
        # Resolve the absolute path to the file for validation
        FILE_PATH="${{ inputs.file_path }}"
        if [[ ! "$FILE_PATH" = /* ]]; then
          FILE_PATH="${{ github.workspace }}/$FILE_PATH"
        fi
        
        # Set the relative path as an environment variable for the validator
        export GITHUB_ACTION_FILE_PATH="$RELATIVE_FILE_PATH"
        
        # Run validator from action directory
        cd ${{ github.action_path }}
        
        # Create output file in workspace for access by calling workflow
        OUTPUT_FILE="${{ github.workspace }}/validation-summary.md"
        TEMP_OUTPUT=$(mktemp)
        
        # Run validation and capture output
        set +e  # Don't exit on error immediately
        npx tsx validate-atlas-markdown.ts "$FILE_PATH" 2>&1 | tee "$TEMP_OUTPUT"
        EXIT_CODE=$?
        set -e
        
        # Create Job Summary (visible in PR checks)
        echo "## ðŸ“‹ Atlas Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**File:** \`$RELATIVE_FILE_PATH\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ $EXIT_CODE -eq 0 ]; then
          echo "has_errors=false" >> $GITHUB_OUTPUT
          echo "### âœ… Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No issues found!" >> $GITHUB_STEP_SUMMARY
          
          # Create summary file for PR comments
          echo "## âœ… Atlas Validation Passed" > "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"
          echo "**File:** \`$RELATIVE_FILE_PATH\`" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"
          echo "No validation errors found!" >> "$OUTPUT_FILE"
        else
          echo "has_errors=true" >> $GITHUB_OUTPUT
          echo "### âŒ Validation Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Click to see all validation errors</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat "$TEMP_OUTPUT" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          
          # Create summary file for PR comments
          echo "## âŒ Atlas Validation Failed" > "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"
          echo "**File:** \`$RELATIVE_FILE_PATH\`" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"
          echo "<details>" >> "$OUTPUT_FILE"
          echo "<summary>ðŸ“‹ Click to see all validation errors</summary>" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"
          echo "\`\`\`" >> "$OUTPUT_FILE"
          cat "$TEMP_OUTPUT" >> "$OUTPUT_FILE"
          echo "\`\`\`" >> "$OUTPUT_FILE"
          echo "</details>" >> "$OUTPUT_FILE"
          
          # Also output errors as annotations
          echo "::error title=Atlas Validation Failed::Check the Job Summary or PR comment for detailed validation errors in $RELATIVE_FILE_PATH"
        fi
        
        # Cleanup temp file
        rm -f "$TEMP_OUTPUT"
        
        # Exit with validation result
        exit $EXIT_CODE

